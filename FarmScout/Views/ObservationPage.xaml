<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:FarmScout.Models"
             xmlns:converters="clr-namespace:FarmScout.Converters"
             x:Class="FarmScout.Views.ObservationPage"
             x:DataType="viewmodels:ObservationViewModel"
             x:Name="ObservationPageRoot"
             xmlns:viewmodels="clr-namespace:FarmScout.ViewModels"
             Title="{Binding Title}">
    
    <ScrollView>
        <VerticalStackLayout Spacing="20" Padding="20">
            
            <!-- Header -->
            <Label Text="{Binding Title}" x:Name="Header"
                   FontSize="24" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Center"
                   TextColor="#2E7D32"/>
            
            <!-- Observation Types -->
            <Border BackgroundColor="#F5F5F5" Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“ Observation Types" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <!-- Edit/Add Mode -->
                    <Button Text="{Binding SelectedTypesDisplay, StringFormat='Selected: {0}'}"
                            Command="{Binding ShowObservationTypesCommand}"
                            BackgroundColor="#E8F5E8"
                            TextColor="#2E7D32"
                            CornerRadius="8"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsEditable}"/>
                    
                    <!-- View Mode -->
                    <Label Text="{Binding SelectedTypesDisplay}" 
                           FontSize="16" 
                           TextColor="#666"
                           IsVisible="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>
            
            <!-- Soil Moisture -->
            <Border BackgroundColor="#F5F5F5" Padding="15"
                   IsVisible="{Binding SelectedObservationTypes, Converter={StaticResource StringContainsConverter}, ConverterParameter=Soil Moisture}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸŒ Soil Moisture" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <!-- Edit/Add Mode -->
                    <Slider Value="{Binding SoilMoisture}" 
                            Minimum="0" 
                            Maximum="100"
                            ThumbColor="#2E7D32"
                            MinimumTrackColor="#4CAF50"
                            MaximumTrackColor="#E0E0E0"
                            IsVisible="{Binding IsEditable}"/>
                    
                    <Label Text="{Binding SoilMoisture, StringFormat='{0:F0}%'}" 
                           FontSize="16" 
                           HorizontalOptions="Center"
                           TextColor="#2E7D32"/>
                </VerticalStackLayout>
            </Border>
            
            <!-- Severity -->
            <Border BackgroundColor="#F5F5F5" Padding="15"><Border.StrokeShape><RoundRectangle CornerRadius="10" /></Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="âš ï¸ Severity" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <!-- Edit/Add Mode -->
                    <Button Text="{Binding SeverityDisplay}"
                            Command="{Binding ShowSeverityPopupCommand}"
                            BackgroundColor="{Binding SeverityColor}"
                            TextColor="White"
                            CornerRadius="8"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsEditable}"/>
                    
                    <!-- View Mode -->
                    <Label Text="{Binding SeverityDisplay}" 
                           FontSize="16" 
                           TextColor="{Binding SeverityColor}"
                           FontAttributes="Bold"
                           IsVisible="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>
            
            <!-- Farm Location -->
            <Border BackgroundColor="#F5F5F5" Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ  Farm Location" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <!-- Edit/Add Mode -->
                    <Button Text="{Binding SelectedFarmLocation, StringFormat='Location: {0}'}"
                            Command="{Binding SelectFarmLocationCommand}"
                            BackgroundColor="#E8F5E8"
                            TextColor="#2E7D32"
                            CornerRadius="8"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsEditable}"/>
                    
                    <!-- View Mode -->
                    <Label Text="{Binding SelectedFarmLocation, StringFormat='Location: {0}'}" 
                           FontSize="16" 
                           TextColor="#666"
                           IsVisible="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>
            
            <!-- Additional Metrics -->
            <Border BackgroundColor="#F5F5F5" Padding="15"
                   IsVisible="{Binding SelectedObservationTypes, Converter={StaticResource StringContainsConverter}, ConverterParameter=Disease}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ¦  Disease Information" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <Entry Placeholder="Disease Name" 
                           Text="{Binding DiseaseName}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Disease Type" 
                           Text="{Binding DiseaseType}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           IsReadOnly="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>

            <Border BackgroundColor="#F5F5F5" Padding="15"
                   IsVisible="{Binding SelectedObservationTypes, Converter={StaticResource StringContainsConverter}, ConverterParameter=Pest}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ› Pest Information" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <Entry Placeholder="Pest Name" 
                           Text="{Binding PestName}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Pest Count" 
                           Text="{Binding PestCount}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>

            <Border BackgroundColor="#F5F5F5" Padding="15"
                   IsVisible="{Binding SelectedObservationTypes, Converter={StaticResource StringContainsConverter}, ConverterParameter=Harvest}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸŒ¾ Harvest Information" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <Entry Placeholder="Crop Type" 
                           Text="{Binding CropType}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Weight (kg)" 
                           Text="{Binding HarvestWeight}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Quantity" 
                           Text="{Binding HarvestQuantity}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>

            <Border BackgroundColor="#F5F5F5" Padding="15"
                   IsVisible="{Binding SelectedObservationTypes, Converter={StaticResource StringContainsConverter}, ConverterParameter=Weather}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸŒ¤ï¸ Weather Information" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <Entry Placeholder="Temperature (Â°C)" 
                           Text="{Binding Temperature}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Humidity (%)" 
                           Text="{Binding Humidity}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Wind Speed (km/h)" 
                           Text="{Binding WindSpeed}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>

            <Border BackgroundColor="#F5F5F5" Padding="15"
                   IsVisible="{Binding SelectedObservationTypes, Converter={StaticResource StringContainsConverter}, ConverterParameter=Soil}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸŒ Soil Information" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <Entry Placeholder="pH Level" 
                           Text="{Binding SoilPH}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Nitrogen (N)" 
                           Text="{Binding SoilNitrogen}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Phosphorus (P)" 
                           Text="{Binding SoilPhosphorus}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                    
                    <Entry Placeholder="Potassium (K)" 
                           Text="{Binding SoilPotassium}"
                           TextColor="Black"
                           BackgroundColor="White"
                           PlaceholderColor="#999"
                           Keyboard="Numeric"
                           IsReadOnly="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>
            
            <!-- Photos -->
            <Border BackgroundColor="#F5F5F5" Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>

                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“· Photos" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <!-- Edit/Add Mode -->
                    <Button Text="Add Photo" 
                            Command="{Binding TakePhotoCommand}"
                            BackgroundColor="#2196F3"
                            TextColor="White"
                            CornerRadius="8"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsEditable}"/>
                    
                    <CollectionView ItemsSource="{Binding Photos}" 
                                  IsVisible="{Binding HasPhotos}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:ObservationPhoto">
                                <Border Margin="5" 
                                       BackgroundColor="White"                                        
                                       Padding="10">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="5" />
                                    </Border.StrokeShape>
                                    <Grid RowDefinitions="Auto,Auto">
                                        <Image Grid.Row="0" 
                                               Source="{Binding PhotoPath}" 
                                               HeightRequest="150"
                                               Aspect="AspectFill"
                                               HorizontalOptions="Center"/>
                                        <!-- Edit/Add Mode -->
                                        <Button Grid.Row="1" 
                                                Text="âŒ Remove" 
                                                Command="{Binding x:DataType=viewmodels:ObservationViewModel, Source={x:Reference ObservationPageRoot}, Path=RemovePhotoCommand}"
                                                CommandParameter="{Binding}"
                                                BackgroundColor="#FF5722"
                                                TextColor="White"
                                                CornerRadius="5"
                                                Margin="0,5,0,0"
                                                IsVisible="{Binding x:DataType=viewmodels:ObservationViewModel, Source={x:Reference ObservationPageRoot}, Path=IsEditable}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>
            
            <!-- Location -->
            <Border BackgroundColor="#F5F5F5" Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“ Location" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <!-- Edit/Add Mode -->
                    <Button Text="Get Current Location" 
                            Command="{Binding GetLocationCommand}"
                            BackgroundColor="#FF9800"
                            TextColor="White"
                            CornerRadius="8"
                            HorizontalOptions="Fill"
                            IsVisible="{Binding IsEditable}"/>
                    
                    <CollectionView ItemsSource="{Binding Locations}" 
                                  IsVisible="{Binding HasLocations}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:ObservationLocation">
                                <Border Margin="5" 
                                       BackgroundColor="White"                                        
                                       Padding="10">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="5" />
                                    </Border.StrokeShape>
                                    <VerticalStackLayout Spacing="5">
                                        <Label Text="{Binding Description}" 
                                               TextColor="Black"
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding Latitude, StringFormat='Latitude: {0:F6}'}" 
                                               TextColor="#666"
                                               FontSize="12"/>
                                        <Label Text="{Binding Longitude, StringFormat='Longitude: {0:F6}'}" 
                                               TextColor="#666"
                                               FontSize="12"/>
                                        <!-- Edit/Add Mode -->
                                        <Button Text="âŒ Remove" 
                                                Command="{Binding x:DataType=viewmodels:ObservationViewModel, Source={x:Reference ObservationPageRoot}, Path=RemoveLocationCommand}"
                                                CommandParameter="{Binding}"
                                                BackgroundColor="#FF5722"
                                                TextColor="White"
                                                CornerRadius="5"
                                                Margin="0,5,0,0"
                                                IsVisible="{Binding x:DataType=viewmodels:ObservationViewModel, Source={RelativeSource AncestorType={x:Type viewmodels:ObservationViewModel}}, Path=IsEditable}"/>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>
            
            <!-- Notes -->
            <Border BackgroundColor="#F5F5F5" Padding="15">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="10" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“ Notes" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="#2E7D32"/>
                    
                    <!-- Edit/Add Mode -->
                    <Editor Placeholder="Enter additional notes..." 
                            Text="{Binding Notes}"
                            TextColor="Black"
                            BackgroundColor="White"
                            PlaceholderColor="#999"
                            AutoSize="TextChanges"
                            MinimumHeightRequest="100"
                            IsReadOnly="{Binding IsViewMode}"/>
                    
                    <!-- View Mode -->
                    <Label Text="{Binding Notes}" 
                           FontSize="16" 
                           TextColor="#666"
                           IsVisible="{Binding IsViewMode}"/>
                </VerticalStackLayout>
            </Border>
            
            <!-- Action Buttons -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                <!-- Back Button -->
                <Button Grid.Column="0"
                        Text="â† Back"
                        Command="{Binding GoBackCommand}"
                        BackgroundColor="#666"
                        TextColor="White"
                        CornerRadius="8"
                        FontSize="16"
                        FontAttributes="Bold"
                        HorizontalOptions="Fill"/>
                
                <Button Grid.Column="1"
                        Text="{Binding IsAddMode, Converter={StaticResource BoolToStringConverter}, ConverterParameter='ðŸ’¾ Save|ðŸ’¾ Update'}"
                        Command="{Binding SaveObservationCommand}"
                        BackgroundColor="{Binding IsAddMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#4CAF50|#FF9800'}"
                        TextColor="White"
                        CornerRadius="8"
                        FontSize="16"
                        FontAttributes="Bold"
                        HorizontalOptions="Fill"
                        IsVisible="{Binding IsEditable}"/>

                <!-- Edit Button (View Mode) -->
                <Button Grid.Column="2"
                        Text="âœï¸ Edit"
                        Command="{Binding EditObservationCommand}"
                        BackgroundColor="#FF9800"
                        TextColor="White"
                        CornerRadius="8"
                        FontSize="16"
                        FontAttributes="Bold"
                        HorizontalOptions="Fill"
                        IsVisible="{Binding IsViewMode}"/>
            </Grid>
            
        </VerticalStackLayout>
    </ScrollView>
</ContentPage> 